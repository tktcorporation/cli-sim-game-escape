# CLI Sim Game Escape

## Project Overview

Rust + WebAssembly で動くターミナルスタイルのブラウザゲームプラットフォーム。
Ratzilla (ratatui wrapper) を使用し、10 ticks/sec の固定タイムステップで動作する。

### Tech Stack
- Rust (Edition 2021), wasm32-unknown-unknown
- Ratzilla (ratatui-based terminal rendering to browser DOM)
- Trunk (build system)
- web-sys (browser APIs)

### Architecture
- `src/main.rs` — エントリポイント、メニュー、イベントループ
- `src/games/mod.rs` — Game trait (handle_input, tick, render)
- `src/games/cookie/` — Cookie Factory ゲーム
- `src/games/factory/` — Tiny Factory ゲーム
- `src/input.rs` — クリック/タップ座標変換
- `src/time.rs` — 固定タイムステップ (10 ticks/sec)

### Design Principles
- **Pure Logic Pattern**: logic.rs に純粋関数、state.rs にデータ、render.rs は読み取り専用
- **Trait-Based Games**: 新ゲーム追加時に main.rs の変更不要
- **Responsive**: 60列を閾値にワイド/ナローレイアウトを切り替え
- 日本語 UI

### PR前チェックリスト
- `cargo test` — 全テスト通過を確認
- `cargo clippy -- -W clippy::all` — 警告ゼロを確認してからPRを出す
- dead_code警告が出たら `#[cfg(test)]` やフィールド削除で対応する

### Important: タッチイベント処理

**タッチ処理はJS側（index.html）で行う。Rust/WASMでは処理しない。**

理由: web-sysのTouchEvent/Touch/TouchList機能を使うと、iOS SafariのWebKit WASMエンジンが
黒画面になる問題がある（コミット 0caf982 で発見・修正）。

現在の実装:
- `index.html` 内のJavaScriptで `touchstart` イベントをリッスン
- クリックされた`<pre>`要素のテキストから `[X]` 形式のキーを正規表現で抽出
- `KeyboardEvent` を `dispatchEvent` してRatzillaの `on_key_event` ハンドラに渡す

正規表現 `/\[([0-9A-Za-z\-=!~{}|\\])\]/` がサポートするキー:
- 生産者: `[1]`〜`[9]`, `[0]`, `[-]`, `[=]`
- タブ: `[{]`, `[|]`, `[\]`, `[}]`, `[~]`
- 一括操作: `[!]`
- アルファベット: `[A]`〜`[Z]`

新しいキーを追加する場合は、この正規表現も更新すること。

---

## Game Design Concepts

### Cookie Factory — コアコンセプト: 「投資戦略」

**コア体験**: 「今この選択が正しいのか？」と考え、実際に効率的な判断ができた時の快感

**プレイヤーの感情**: 「Farmを今3台買うより、もう少し貯めてMineを1台買った方が回収が早い…！」

**主軸**: 複数の投資先から最適な選択を見極める戦略的判断

**デザイン原則**:
- すべての要素は「投資判断を面白くする」ために存在する
- 情報は隠さず見せる（CPS/コスト比率、回収時間など）— 戦略ゲームは情報が命
- 「明らかな最適解」を避け、状況によって最適な選択が変わるようにする
- 数字のインフレ自体は手段であり目的ではない — インフレは戦略の新しいフェーズを開くために使う

**現状の課題**:
- 生産者5種が単純な上位互換で、戦略的深さが薄い
- アップグレードは×2固定で、購入タイミングの判断余地がない
- ROI（投資回収率）が可視化されておらず、戦略を感覚でしか判断できない
- コストカーブが固定的で「今買うか貯めるか」のジレンマが弱い

**強化の方向性**:
- 投資効率の可視化（CPS/コスト、回収時間の表示）
- 生産者間のシナジーや相互作用で「組み合わせ」の戦略を生む
- 複数の投資パスで「どちらを先に取るか」のジレンマ
- コストカーブの調整で常に判断が面白い状態を維持

---

### Tiny Factory — コアコンセプト: 「流れの気持ちよさ」

**コア体験**: 自分が配置した機械とベルトで、素材がスムーズに流れて製品になっていくのを眺める満足感

**プレイヤーの感情**: 「おお、鉱石がベルトに乗って、精錬されて、ギアになって、出荷される…！全部繋がった！」

**主軸**: 生産ラインの「流れ」を視覚的に体感できること

**デザイン原則**:
- すべての演出は「流れが見える・感じられる」ために存在する
- アイテムの移動は滑らかに、目で追えるように表現する
- 生産完了・売却の瞬間には明確なフィードバックを返す
- 配置の自由度を確保し、「自分だけのライン」を作れる楽しさを守る
- 効率の追求はあくまで二次的な楽しみ — まず流れが気持ちいいことが最優先

**現状の課題**:
- アイテムの移動が1文字表現で流れが見えにくい
- ベルトのアニメーションが地味（方向記号の切り替えのみ）
- 生産完了や売却の瞬間にフィードバックがない
- ラインが「上手く流れている」ことの実感が薄い

**強化の方向性**:
- アイテムの流れを視覚的に表現する演出強化
- 生産完了・売却時のフィードバック（フラッシュ、ログ演出など）
- スループット可視化（「1秒に何個流れているか」）
- ベルト配置のUX改善（連続配置など）
