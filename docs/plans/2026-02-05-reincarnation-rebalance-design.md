# 転生システム リバランス設計

## 概要

Cookie Factory の転生（Prestige）システムを強化し、「転生する旨み」を大幅に向上させる。

### 設計目標

1. **加速感** — 2周目以降が明らかに速く進む
2. **ビルドの多様性** — 転生ごとに異なる戦略を試せる
3. **収集要素** — 永続アップグレードを集める楽しさ
4. **新コンテンツ解放** — 転生回数で新機能がアンロック

### 設計方針

- **完全リセット + 強力ボーナス** — リセット量は維持、ボーナスを大幅強化
- **目標: 転生後30分で前回到達点**

---

## 1. チップ効果の強化

### 変更内容

| 項目 | 旧 | 新 |
|------|-----|-----|
| 1チップあたりのCPSボーナス | +1% | +5% |

### 計算例

| 累計クッキー | チップ | 旧ボーナス | 新ボーナス |
|-------------|--------|-----------|-----------|
| 1兆 | 1 | +1% | +5% |
| 100兆 | 10 | +10% | +50% |
| 1京 | 100 | +100% | +500% |

### 実装箇所

- `logic.rs` の `perform_prestige()` 関数内、`chip_bonus` 計算式
- 旧: `1.0 + heavenly_chips * 0.01`
- 新: `1.0 + heavenly_chips * 0.05`

---

## 2. 砂糖（Sugar）システム

### 基本仕様

| 項目 | 内容 |
|------|------|
| 獲得方法 | 転生時、獲得チップの10%が砂糖として付与 |
| 保持 | 転生しても消えない（永続リソース） |
| 上限 | なし |

### 使い道: 生産ブースト

| ブースト名 | 砂糖コスト | 効果 | 持続時間 |
|-----------|-----------|------|---------|
| シュガーラッシュ | 1 | CPS ×2 | 30秒 |
| シュガーフィーバー | 5 | CPS ×5 | 30秒 |
| シュガーフレンジー | 20 | CPS ×10 | 60秒 |

### 戦略的意図

- 「今使うか、貯めて大きいのを使うか」の判断
- ゴールデンクッキーとの併用で爆発的な生産（掛け算）
- アクティブプレイに報酬を与える

### 実装

#### state.rs に追加

```rust
pub struct CookieState {
    // ... 既存フィールド ...

    // === 砂糖システム ===
    pub sugar: u64,              // 現在の砂糖量
    pub sugar_all_time: u64,     // 累計獲得砂糖
    pub sugar_boosts: Vec<SugarBoost>,  // 利用可能なブースト
    pub active_sugar_boost: Option<ActiveSugarBoost>,  // 発動中のブースト
}

pub struct SugarBoost {
    pub name: String,
    pub cost: u64,
    pub multiplier: f64,
    pub duration_ticks: u32,
}

pub struct ActiveSugarBoost {
    pub multiplier: f64,
    pub remaining_ticks: u32,
}
```

#### logic.rs に追加

- `activate_sugar_boost()` — 砂糖を消費してブースト発動
- `tick_sugar_boost()` — 毎tick、残り時間を減らす
- CPS計算時に `active_sugar_boost.multiplier` を乗算

---

## 3. 転生アップグレードのツリー構造

### 構造

```
              [天使の贈り物] (1チップ) — 開始時1,000クッキー
                    │
        ┌──────────┼──────────┐
        ▼          ▼          ▼
    【生産パス】 【クリックパス】 【幸運パス】
```

### 生産パス（放置向け）

| 名前 | コスト | 効果 | 前提 |
|------|--------|------|------|
| 天界の力 | 3 | CPS ×1.5 | 天使の贈り物 |
| 天使のオーラ | 10 | CPS ×2 | 天界の力 |
| 工場の記憶 | 25 | 転生後、Cursor を5台所持で開始 | 天使のオーラ |
| 効率の極致 | 50 | 全生産者のコスト -10% | 工場の記憶 |
| 天界の富 | 100 | 開始時 1,000,000 クッキー | 効率の極致 |

### クリックパス（アクティブ向け）

| 名前 | コスト | 効果 | 前提 |
|------|--------|------|------|
| 天使のクリック | 3 | クリック力 ×2 | 天使の贈り物 |
| 神のクリック | 10 | クリック力 ×3 | 天使のクリック |
| 砂糖錬金術 | 25 | 砂糖ブーストの効果 +50% | 神のクリック |
| 連撃の極意 | 50 | 10連続クリックで追加ボーナス | 砂糖錬金術 |
| クリックの覇者 | 100 | クリック力 ×5 | 連撃の極意 |

### 幸運パス（イベント向け）

| 名前 | コスト | 効果 | 前提 |
|------|--------|------|------|
| ゴールデンラッシュ | 3 | ゴールデンクッキー出現 1.5倍速 | 天使の贈り物 |
| 黄金の直感 | 10 | ゴールデンクッキーの位置を予告 | ゴールデンラッシュ |
| 幸運の延長 | 25 | ゴールデン効果の持続時間 +50% | 黄金の直感 |
| ミルクの記憶 | 50 | ミルク 50% 保持 | 幸運の延長 |
| 幸運の支配者 | 100 | ゴールデン効果 ×2 | ミルクの記憶 |

### 実装

#### state.rs の PrestigeUpgrade を拡張

```rust
pub struct PrestigeUpgrade {
    pub id: &'static str,        // 一意識別子
    pub name: String,
    pub description: String,
    pub cost: u64,
    pub purchased: bool,
    pub effect: PrestigeEffect,
    pub requires: Option<&'static str>,  // 前提アップグレードのID
    pub path: PrestigePath,      // 所属パス
}

pub enum PrestigePath {
    Root,       // 天使の贈り物
    Production, // 生産パス
    Click,      // クリックパス
    Luck,       // 幸運パス
}
```

---

## 4. 転生回数で解放される新システム

### 解放スケジュール

| 転生回数 | 解放される機能 | 効果 |
|---------|---------------|------|
| 1回 | **オートクリッカー** | 毎秒1回自動クリック |
| 3回 | **砂糖フレンジー** | 最大効率の砂糖ブーストが解放 |
| 5回 | **生産者プリセット** | ワンクリックでまとめ買い |
| 10回 | **オートクリッカー強化** | 毎秒5回に向上 |

### オートクリッカー仕様

- 転生1回で永続解放（以降の全プレイで有効）
- UIに「Auto」表示、ON/OFF切り替え可能
- クリックパスのアップグレードと相乗効果

### 生産者プリセット仕様

- 転生後に「前回の構成を再現」ボタン
- 必要なクッキーがあれば一括購入
- 序盤の繰り返し作業を軽減

### 実装

#### state.rs に追加

```rust
pub struct CookieState {
    // ... 既存フィールド ...

    // === 解放機能 ===
    pub auto_clicker_enabled: bool,    // オートクリッカーON/OFF
    pub auto_clicker_rate: u32,        // 毎秒クリック回数（1 or 5）
    pub last_producer_config: Vec<u32>, // 前回転生時の生産者台数
}
```

#### logic.rs に追加

- `tick_auto_clicker()` — 毎tick、自動クリック判定
- `apply_producer_preset()` — プリセット適用
- `is_feature_unlocked(feature, prestige_count)` — 機能解放判定

---

## 5. バランス調整の指針

### 目標: 転生後30分で前回到達点

| 転生前 | 転生後の加速 | 実現手段 |
|--------|-------------|---------|
| 1兆クッキーに3時間 | 1時間 | チップボーナス +5%/チップ |
| 生産者を1から買い直し | 初期生産者+購入加速 | アップグレード効果 |
| 手動クリックで序盤稼ぎ | 自動化 | オートクリッカー |

### インフレ管理

- チップ効果は加算（+5%/チップ）→ 際限なく増えるが緩やか
- 砂糖ブーストは一時的 → 常時インフレしない
- 転生アップグレードは上限あり（16種で打ち止め）

### 段階的な体験

```
転生0回: 普通にプレイ、1兆到達で転生可能に
転生1回: +5%ボーナス、オートクリッカー解放、「速い！」
転生3回: ツリー分岐を選び始める、ビルドの個性
転生5回: プリセットで快適、砂糖を戦略的に使う
転生10回: 全機能解放、やり込みフェーズ
```

---

## 実装優先度

1. **チップ効果強化** — 最も簡単、即効性あり
2. **転生アップグレード拡張** — ツリー構造の実装
3. **砂糖システム** — 新リソースの追加
4. **オートクリッカー** — 転生回数による解放
5. **生産者プリセット** — QoL機能

---

## 関連ファイル

- `src/games/cookie/state.rs` — データ構造
- `src/games/cookie/logic.rs` — ゲームロジック
- `src/games/cookie/render.rs` — UI表示
