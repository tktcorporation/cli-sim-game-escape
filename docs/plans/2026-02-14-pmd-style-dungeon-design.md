# ポケダン風ダンジョンシステム設計

## 概要

現在のDFS迷路ベースのダンジョンを、ポケモン不思議のダンジョン風の
「部屋＋通路」型に全面改修する。視界・操作・マップ生成を一括で変更。

## 課題

1. **マップが小さすぎる**: F1が7×7=49セルで「部屋」の概念が成立しない
2. **視界が狭い**: 踏んだセルだけ見える → 壁にぶつかり続ける
3. **操作感が悪い**: facing+前進方式がD-padの期待と合わない

## 設計

### 1. マップ生成: セクション分割型

マップを3×3のセクションに分割し、各セクション内に矩形部屋を配置。

- **グリッドサイズ**: F1-2: 27×27, F3-5: 33×33, F6-9: 39×39, F10: 27×27
- **セクション**: 各9×9～13×13セル
- **部屋サイズ**: 4×4 ～ 7×7 の矩形
- **空セクション**: 1-2区画は部屋なし（通路のみ通過）
- **通路**: 1幅、ドアから隣部屋のドアへ直線 or L字接続
- **特殊配置**: Entrance=下段中央の部屋、Stairs=上段の部屋（最遠）

### 2. データモデル: 壁ベース → タイルベース

```rust
#[derive(Clone, Copy, PartialEq)]
pub enum Tile {
    Wall,
    RoomFloor,
    Corridor,
}

pub struct MapCell {
    pub tile: Tile,
    pub cell_type: CellType,
    pub visited: bool,      // プレイヤーが踏んだ
    pub revealed: bool,     // 視界に入ったことがある（auto-map）
    pub event_done: bool,
    pub room_id: Option<u8>,
}
```

`walls: [bool; 4]` を廃止。壁は隣接タイルが `Tile::Wall` かで判定。

### 3. 視界システム: 部屋認識型

- **部屋内**: 同じ `room_id` の全タイル + 隣接ドア/通路1マスが可視
- **通路内**: 周囲2マス（全方向）が可視
- **auto-map**: `revealed=true` のタイルは薄い色で常時表示

### 4. 移動: 絶対方向移動

`facing` フィールドを廃止。D-pad/矢印キーで直接その方向に1歩移動。

- `[▲]` = 北、`[▶]` = 東、`[▼]` = 南、`[◀]` = 西
- 壁（`Tile::Wall`）なら移動不可
- map tap 自動歩行は維持

### 5. レンダリング: 1タイル = 2文字幅 × 1行高

- **壁**: `██` (テーマ色)
- **部屋床**: `  ` (空白、明るめ背景)
- **通路**: `  ` (暗め背景)
- **プレイヤー**: `＠` or `@`
- **未探索**: `░░`
- **探索済み非可視**: 薄い色
- **ビューポート**: 13×13 ～ 19×19 タイル（画面に応じて動的調整）

### 6. 3D描写テキスト

`compute_view` を新データモデルに合わせて更新。
前方の壁/通路/部屋入口を検出して描写テキストを生成。
facing廃止に伴い、最後に移動した方向を「前方」として扱う。

## 影響範囲

- `dungeon_map.rs` — 生成アルゴリズム全面書き換え
- `state.rs` — `MapCell`, `DungeonMap` 構造体変更
- `dungeon_view.rs` — レンダリング全面書き換え
- `render.rs` — D-pad/ビューポート計算の変更
- `logic.rs` — 移動ロジック変更（facing廃止）
- `mod.rs` — 入力ハンドリング変更
- テスト全面更新
